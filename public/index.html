<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Plant Montana</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Serif+Display&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --green-dark:#3a5f44;--green:#4a7c59;--green-mid:#6ba368;--green-light:#8fbc8b;
  --terra:#c4956a;--terra-bright:#e07c4f;
  --brown:#8a7e6f;--brown-light:#b5a99a;
  --cream:#faf8f5;--cream-dark:#f0ece6;--cream-darker:#e5dfd7;
  --white:#ffffff;--text:#2c2416;--text-secondary:#6b5e4f;--text-dim:#a69880;
  --blue:#5b8fb9;--orange:#e07c4f;--red:#c44569;
  --radius:16px;--radius-sm:10px;
  --shadow:0 2px 12px rgba(44,36,22,0.06);
  --shadow-lg:0 8px 32px rgba(44,36,22,0.1);
  --bottom-nav:72px;
  --safe-bottom:env(safe-area-inset-bottom, 0px);
}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text);line-height:1.6;
  padding-bottom:calc(var(--bottom-nav) + var(--safe-bottom) + 12px);overflow-x:hidden}
h1,h2,h3,.serif{font-family:'DM Serif Display',serif;font-weight:400}
a{color:var(--green);text-decoration:none}
input,select,button{font-family:'DM Sans',sans-serif;font-size:1rem}

/* ===== BOTTOM NAV ===== */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:var(--white);border-top:1px solid var(--cream-dark);
  padding:6px 0 calc(6px + var(--safe-bottom));
  display:flex;justify-content:space-around;align-items:center;
  box-shadow:0 -4px 20px rgba(44,36,22,0.06)}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:6px 12px;border-radius:12px;cursor:pointer;transition:all 0.2s;
  color:var(--text-dim);-webkit-tap-highlight-color:transparent;border:none;background:none}
.nav-item svg{width:22px;height:22px;stroke-width:1.8}
.nav-item span{font-size:0.65rem;font-weight:500;letter-spacing:0.02em}
.nav-item.active{color:var(--green)}
.nav-item.active svg{stroke-width:2.2}
.nav-item:active{transform:scale(0.92)}

/* ===== TOP BAR ===== */
.top-bar{position:sticky;top:0;z-index:50;background:rgba(250,248,245,0.85);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  padding:12px 20px;display:flex;align-items:center;gap:10px}
.top-bar .logo{font-family:'DM Serif Display',serif;font-size:1.25rem;color:var(--green);
  display:flex;align-items:center;gap:8px}
.top-bar .logo svg{width:22px;height:22px;color:var(--green-mid)}

/* ===== MAIN ===== */
main{padding:0 16px 16px;max-width:600px;margin:0 auto}
.page{display:none}.page.active{display:block}

/* ===== CARDS ===== */
.card{background:var(--white);border-radius:var(--radius);padding:16px;
  box-shadow:var(--shadow);transition:transform 0.15s;position:relative;overflow:hidden}
.card:active{transform:scale(0.98)}

/* ===== DASHBOARD ===== */
.dash-hero{background:linear-gradient(145deg,var(--green-dark) 0%,var(--green) 40%,var(--green-mid) 100%);
  color:white;border-radius:var(--radius);padding:28px 24px;margin-bottom:16px;position:relative;overflow:hidden}
.dash-hero::after{content:'';position:absolute;top:-40px;right:-40px;width:160px;height:160px;
  border-radius:50%;background:rgba(255,255,255,0.06)}
.dash-hero h1{font-size:1.6rem;line-height:1.15;margin-bottom:6px;position:relative}
.dash-hero p{opacity:0.85;font-size:0.9rem;font-weight:300;position:relative}

.frost-strip{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.frost-card{background:var(--white);border-radius:var(--radius-sm);padding:14px;text-align:center;box-shadow:var(--shadow)}
.frost-card .num{font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--green);line-height:1.2}
.frost-card .label{font-size:0.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-top:2px}

.section-header{font-size:1.15rem;color:var(--green);margin:20px 0 10px;display:flex;align-items:center;gap:8px}
.section-header svg{width:20px;height:20px}

.tip-banner{background:linear-gradient(135deg,var(--terra),var(--terra-bright));
  color:white;border-radius:var(--radius);padding:18px 20px;margin-bottom:16px}
.tip-banner h3{font-size:0.95rem;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.tip-banner h3 svg{width:18px;height:18px}
.tip-banner p{font-size:0.88rem;opacity:0.95;line-height:1.5}

/* Plant list - compact mobile cards */
.plant-list{display:flex;flex-direction:column;gap:10px}
.plant-row{display:flex;align-items:center;gap:14px;background:var(--white);
  border-radius:var(--radius-sm);padding:14px 16px;box-shadow:var(--shadow);cursor:pointer;
  -webkit-tap-highlight-color:transparent;transition:transform 0.15s}
.plant-row:active{transform:scale(0.98)}
.plant-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.plant-icon svg{width:22px;height:22px;color:white}
.plant-icon.vegetable{background:var(--green)}.plant-icon.herb{background:var(--terra)}
.plant-icon.flower{background:var(--terra-bright)}.plant-icon.fruit{background:var(--red)}
.plant-info{flex:1;min-width:0}
.plant-info h3{font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:600;line-height:1.2}
.plant-info .meta{font-size:0.78rem;color:var(--text-dim);display:flex;gap:10px;margin-top:2px}
.plant-info .meta span{display:flex;align-items:center;gap:3px}
.plant-info .meta svg{width:12px;height:12px}
.plant-row .chevron{color:var(--cream-darker);flex-shrink:0}
.plant-row .chevron svg{width:18px;height:18px}

/* ===== FILTERS ===== */
.filter-bar{display:flex;gap:8px;overflow-x:auto;padding:4px 0 12px;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;-ms-overflow-style:none}
.filter-bar::-webkit-scrollbar{display:none}
.pill{padding:8px 16px;border-radius:20px;border:1.5px solid var(--cream-darker);background:var(--white);
  cursor:pointer;font-size:0.82rem;font-weight:500;white-space:nowrap;transition:all 0.2s;
  -webkit-tap-highlight-color:transparent;color:var(--text-secondary)}
.pill.active{background:var(--green);color:white;border-color:var(--green)}
.pill:active{transform:scale(0.95)}

.search-box{width:100%;padding:12px 16px 12px 44px;border:1.5px solid var(--cream-darker);
  border-radius:var(--radius-sm);background:var(--white);font-size:0.95rem;
  margin-bottom:8px;transition:border-color 0.2s;position:relative}
.search-box:focus{outline:none;border-color:var(--green-mid)}
.search-wrap{position:relative;margin-bottom:4px}
.search-wrap svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--text-dim)}

/* ===== CALENDAR ===== */
.calendar-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px}
.cal-table{width:100%;min-width:700px;border-collapse:separate;border-spacing:0}
.cal-table th{font-size:0.65rem;text-transform:uppercase;color:var(--text-dim);padding:6px 3px;
  text-align:center;font-weight:500;position:sticky;top:0;background:var(--cream)}
.cal-table td{padding:2px 1.5px}
.cal-table .pname{font-size:0.8rem;font-weight:500;white-space:nowrap;padding-right:8px;
  min-width:100px;cursor:pointer;color:var(--green)}
.cal-bar{height:14px;border-radius:4px}
.cal-indoor{background:var(--blue)}.cal-outdoor{background:var(--green-mid)}.cal-harvest{background:var(--orange)}

.legend{display:flex;gap:12px;margin-bottom:12px;font-size:0.78rem;color:var(--text-dim)}
.legend span{display:flex;align-items:center;gap:5px}
.legend-dot{width:14px;height:8px;border-radius:3px}

/* ===== PLANNER ===== */
.planner-form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group.full{grid-column:1/-1}
.form-group label{font-size:0.78rem;font-weight:500;color:var(--text-secondary)}
.form-group input,.form-group select{padding:10px 14px;border:1.5px solid var(--cream-darker);
  border-radius:var(--radius-sm);background:var(--white)}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--green-mid)}

.btn{padding:12px 20px;border-radius:var(--radius-sm);border:none;font-weight:600;
  cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent;font-size:0.9rem}
.btn:active{transform:scale(0.96)}
.btn-primary{background:var(--green);color:white}
.btn-primary:hover{background:var(--green-dark)}
.btn-secondary{background:var(--cream-dark);color:var(--text-secondary)}
.btn-row{display:flex;gap:8px;margin-bottom:14px}

.grid-scroll{overflow:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px 16px}
.garden-grid{display:inline-grid;gap:1px;background:var(--brown-light);border-radius:var(--radius-sm);overflow:hidden;padding:1px}
.garden-cell{width:44px;height:44px;background:var(--cream);display:flex;align-items:center;
  justify-content:center;cursor:pointer;font-size:0.55rem;font-weight:600;text-align:center;
  transition:background 0.1s;-webkit-tap-highlight-color:transparent;line-height:1.1;color:var(--text-secondary)}
.garden-cell:active{background:var(--cream-dark)}
.garden-cell.filled{background:#e8f5e9;color:var(--green)}
.garden-cell.filled.conflict{background:#ffebee;color:var(--red)}
.garden-cell.filled.good-companion{background:#c8e6c9;color:var(--green-dark)}

.placing-indicator{background:var(--cream-dark);border-radius:var(--radius-sm);
  padding:10px 14px;font-size:0.85rem;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text-secondary)}
.placing-indicator svg{width:16px;height:16px;color:var(--green)}

.saved-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;
  background:var(--white);border-radius:var(--radius-sm);box-shadow:var(--shadow);margin-bottom:8px}
.saved-item .info h4{font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600}
.saved-item .info p{font-size:0.75rem;color:var(--text-dim)}
.saved-item .actions{display:flex;gap:4px}
.saved-item .actions button{background:none;border:none;cursor:pointer;color:var(--text-dim);
  padding:8px;border-radius:8px;-webkit-tap-highlight-color:transparent}
.saved-item .actions button:active{background:var(--cream-dark)}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;
  align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--white);border-radius:24px 24px 0 0;width:100%;max-width:600px;
  max-height:88vh;overflow-y:auto;padding:8px 24px 32px;
  animation:slideUp 0.25s ease-out}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--cream-darker);border-radius:2px;margin:8px auto 20px}
.modal-close{position:absolute;top:16px;right:20px;background:var(--cream-dark);border:none;
  width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;
  color:var(--text-secondary)}
.modal h2{font-size:1.4rem;margin-bottom:4px}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:0.75rem;font-weight:500}
.badge-vegetable{background:#e8f5e9;color:var(--green)}
.badge-herb{background:#fff3e0;color:var(--terra)}
.badge-flower{background:#fce4ec;color:var(--terra-bright)}
.badge-fruit{background:#fce4ec;color:var(--red)}

.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.detail-item{display:flex;align-items:center;gap:8px;font-size:0.88rem}
.detail-item svg{width:18px;height:18px;color:var(--green-mid);flex-shrink:0}

.detail-section{margin-top:20px}
.detail-section h3{font-size:1rem;margin-bottom:8px;color:var(--green)}

.timeline-months{display:grid;grid-template-columns:repeat(12,1fr);gap:2px;margin:8px 0}
.tl-month{height:28px;border-radius:4px;background:var(--cream-dark);font-size:0.6rem;
  display:flex;align-items:center;justify-content:center;color:var(--text-dim)}
.tl-month.indoor{background:var(--blue);color:white}
.tl-month.outdoor{background:var(--green-mid);color:white}
.tl-month.harvest{background:var(--orange);color:white}

.tag-list{display:flex;flex-wrap:wrap;gap:6px}
.tag{padding:4px 10px;border-radius:10px;font-size:0.8rem}
.tag-good{background:#e8f5e9;color:var(--green)}
.tag-bad{background:#ffebee;color:var(--red)}

.date-row{font-size:0.82rem;color:var(--text-dim);display:flex;align-items:center;gap:6px;margin-top:4px}
.date-row svg{width:14px;height:14px}

/* Desktop tweaks */
@media(min-width:768px){
  main{padding:0 24px 24px}
  .bottom-nav{display:none}
  .top-nav-desktop{display:flex}
  body{padding-bottom:0}
  .modal{border-radius:var(--radius);max-height:90vh;margin:2rem auto}
  .modal-overlay{align-items:center}
}
.top-nav-desktop{display:none;gap:4px}
.top-nav-desktop button{background:none;border:none;padding:8px 14px;border-radius:8px;
  cursor:pointer;font-size:0.9rem;color:var(--text-dim);font-weight:500;
  display:flex;align-items:center;gap:6px;transition:all 0.2s}
.top-nav-desktop button svg{width:18px;height:18px}
.top-nav-desktop button.active{background:var(--cream-dark);color:var(--green)}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="logo"><i data-lucide="leaf"></i> Plant Montana</div>
  <div style="flex:1"></div>
  <div class="top-nav-desktop">
    <button class="active" onclick="showPage('dashboard',this)"><i data-lucide="sprout"></i> Dashboard</button>
    <button onclick="showPage('calendar',this)"><i data-lucide="calendar"></i> Calendar</button>
    <button onclick="showPage('plants',this)"><i data-lucide="grid-3x3"></i> Plants</button>
    <button onclick="showPage('planner',this)"><i data-lucide="layout-grid"></i> Planner</button>
  </div>
</div>

<main>
  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="dash-hero">
      <h1>Plant Montana</h1>
      <p>Your gardening guide for Western Montana</p>
      <p style="font-size:0.78rem;opacity:0.7;margin-top:4px">USDA Zone 4bâ€“6a &middot; Missoula Area</p>
    </div>
    <div class="frost-strip">
      <div class="frost-card" id="frost-countdown"><div class="num">--</div><div class="label">Days to frost</div></div>
      <div class="frost-card"><div class="num">128</div><div class="label">Growing season</div></div>
      <div class="frost-card"><div class="num">May 17</div><div class="label">Last spring frost</div></div>
      <div class="frost-card"><div class="num">Sep 22</div><div class="label">First fall frost</div></div>
    </div>
    <div id="tip-section"></div>
    <div id="indoor-section"></div>
    <div id="outdoor-section"></div>
    <div id="harvest-section"></div>
  </div>

  <!-- CALENDAR -->
  <div id="page-calendar" class="page">
    <h2 class="section-header" style="margin-top:4px"><i data-lucide="calendar"></i> Planting Calendar</h2>
    <div class="search-wrap"><i data-lucide="search"></i><input class="search-box" id="cal-search" placeholder="Search plants..." oninput="renderCalendar()"></div>
    <div class="filter-bar">
      <button class="pill active" data-cat="all" onclick="toggleCatFilter(this)">All</button>
      <button class="pill" data-cat="vegetable" onclick="toggleCatFilter(this)">Vegetables</button>
      <button class="pill" data-cat="herb" onclick="toggleCatFilter(this)">Herbs</button>
      <button class="pill" data-cat="flower" onclick="toggleCatFilter(this)">Flowers</button>
      <button class="pill" data-cat="fruit" onclick="toggleCatFilter(this)">Fruits</button>
    </div>
    <div class="legend">
      <span><div class="legend-dot" style="background:var(--blue)"></div> Indoors</span>
      <span><div class="legend-dot" style="background:var(--green-mid)"></div> Outdoors</span>
      <span><div class="legend-dot" style="background:var(--orange)"></div> Harvest</span>
    </div>
    <div class="calendar-scroll" id="calendar-body"></div>
  </div>

  <!-- PLANTS -->
  <div id="page-plants" class="page">
    <h2 class="section-header" style="margin-top:4px"><i data-lucide="grid-3x3"></i> Plant Database</h2>
    <div class="search-wrap"><i data-lucide="search"></i><input class="search-box" id="plant-search" placeholder="Search plants..." oninput="renderPlants()"></div>
    <div class="filter-bar">
      <button class="pill active" data-cat="all" onclick="togglePlantFilter(this)">All</button>
      <button class="pill" data-cat="vegetable" onclick="togglePlantFilter(this)">Vegetables</button>
      <button class="pill" data-cat="herb" onclick="togglePlantFilter(this)">Herbs</button>
      <button class="pill" data-cat="flower" onclick="togglePlantFilter(this)">Flowers</button>
      <button class="pill" data-cat="fruit" onclick="togglePlantFilter(this)">Fruits</button>
    </div>
    <div class="plant-list" id="plants-grid"></div>
  </div>

  <!-- PLANNER -->
  <div id="page-planner" class="page">
    <h2 class="section-header" style="margin-top:4px"><i data-lucide="layout-grid"></i> Garden Planner</h2>
    <div class="planner-form">
      <div class="form-group"><label>Width (ft)</label><input type="number" id="bed-width" value="4" min="1" max="20"></div>
      <div class="form-group"><label>Height (ft)</label><input type="number" id="bed-height" value="8" min="1" max="20"></div>
      <div class="form-group full"><label>Plant to place</label><select id="plant-select"><option value="">-- Select a plant --</option></select></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="createGrid()">Create Bed</button>
      <button class="btn btn-secondary" onclick="clearGrid()">Clear</button>
    </div>
    <div id="selected-indicator" class="placing-indicator" style="display:none"></div>
    <div class="grid-scroll" id="grid-wrapper"></div>
    <h3 class="section-header" style="font-size:1rem"><i data-lucide="save"></i> Saved Layouts</h3>
    <div class="planner-form" style="margin-top:8px">
      <div class="form-group full" style="flex-direction:row;gap:8px;align-items:end">
        <div style="flex:1"><label>Layout Name</label><input type="text" id="layout-name" placeholder="My Garden Bed" style="width:100%"></div>
        <button class="btn btn-primary" onclick="saveLayout()" style="padding:10px 16px;white-space:nowrap">Save</button>
      </div>
    </div>
    <div id="saved-layouts"></div>
  </div>
</main>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('dashboard',this)" id="nav-dashboard">
    <i data-lucide="sprout"></i><span>Home</span>
  </button>
  <button class="nav-item" onclick="showPage('calendar',this)" id="nav-calendar">
    <i data-lucide="calendar"></i><span>Calendar</span>
  </button>
  <button class="nav-item" onclick="showPage('plants',this)" id="nav-plants">
    <i data-lucide="flower-2"></i><span>Plants</span>
  </button>
  <button class="nav-item" onclick="showPage('planner',this)" id="nav-planner">
    <i data-lucide="grid-3x3"></i><span>Planner</span>
  </button>
</nav>

<!-- MODAL -->
<div class="modal-overlay" id="plant-modal" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal-content"></div>
</div>

<script>
let allPlants=[], calendarData=null, currentCatFilter='all', plantCatFilter='all';
let gridData={}, gridW=4, gridH=8, selectedPlantId=null;

async function init(){
  const [plantsRes,nowRes]=await Promise.all([
    fetch('/api/plants').then(r=>r.json()),
    fetch('/api/now').then(r=>r.json())
  ]);
  allPlants=plantsRes;
  renderDashboard(nowRes);
  renderPlants();
  populatePlantSelect();
  loadSavedLayouts();
  lucide.createIcons();
}

function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  // Bottom nav
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  const navBtn=document.getElementById('nav-'+id);
  if(navBtn)navBtn.classList.add('active');
  // Desktop nav
  document.querySelectorAll('.top-nav-desktop button').forEach(b=>b.classList.remove('active'));
  if(btn&&btn.closest('.top-nav-desktop'))btn.classList.add('active');
  if(id==='calendar'&&!calendarData)loadCalendar();
  window.scrollTo(0,0);
}

// Dashboard
function renderDashboard(data){
  const fc=data.frostCountdown;
  const fcEl=document.getElementById('frost-countdown');
  fcEl.querySelector('.num').textContent=fc.days;
  fcEl.querySelector('.label').textContent=fc.direction==='past'?'Season ended':fc.event;

  if(data.tip){
    document.getElementById('tip-section').innerHTML=`<div class="tip-banner"><h3><i data-lucide="lightbulb"></i> ${data.monthName} Tip</h3><p>${data.tip}</p></div>`;
  }
  renderDashSection('indoor-section','Start Indoors Now','sprout',data.startIndoors);
  renderDashSection('outdoor-section','Plant Outside Now','sun',data.plantOutside);
  renderDashSection('harvest-section','Ready to Harvest','scissors',data.harvest);
  lucide.createIcons();
}

function renderDashSection(elId,title,icon,plants){
  const el=document.getElementById(elId);
  if(!plants||!plants.length){el.innerHTML='';return}
  el.innerHTML=`<h2 class="section-header"><i data-lucide="${icon}"></i> ${title}</h2>
    <div class="plant-list">${plants.map(p=>plantRowHTML(p)).join('')}</div>`;
  lucide.createIcons();
}

function plantRowHTML(p){
  const iconName=p.category==='vegetable'?'carrot':p.category==='herb'?'leaf':p.category==='flower'?'flower-2':'cherry';
  return `<div class="plant-row" onclick="openModal(${p.id})">
    <div class="plant-icon ${p.category}"><i data-lucide="${iconName}"></i></div>
    <div class="plant-info">
      <h3>${p.name}</h3>
      <div class="meta">
        <span><i data-lucide="sun"></i> ${p.sun||''}</span>
        <span><i data-lucide="droplets"></i> ${p.water||''}</span>
        ${p.days_to_harvest?`<span><i data-lucide="timer"></i> ${p.days_to_harvest}d</span>`:''}
      </div>
    </div>
    <div class="chevron"><i data-lucide="chevron-right"></i></div>
  </div>`;
}

// Plants page
function renderPlants(){
  const search=document.getElementById('plant-search').value.toLowerCase();
  let filtered=allPlants;
  if(plantCatFilter!=='all')filtered=filtered.filter(p=>p.category===plantCatFilter);
  if(search)filtered=filtered.filter(p=>p.name.toLowerCase().includes(search));
  document.getElementById('plants-grid').innerHTML=filtered.map(p=>plantRowHTML(p)).join('');
  lucide.createIcons();
}

function togglePlantFilter(btn){
  btn.closest('.filter-bar').querySelectorAll('.pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');plantCatFilter=btn.dataset.cat;renderPlants();
}

// Calendar
async function loadCalendar(){calendarData=await fetch('/api/calendar').then(r=>r.json());renderCalendar()}
const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const MONTH_MAP={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};

function parseDateRange(str){
  if(!str)return null;
  const parts=str.split(' - ');
  const parseOne=s=>{const p=s.trim().split(' ');return{month:MONTH_MAP[p[0]],day:parseInt(p[1])}};
  const start=parseOne(parts[0]);const end=parts[1]?parseOne(parts[1]):{...start};
  return{start,end};
}
function monthsInRange(range){
  if(!range)return[];const months=[];let m=range.start.month;
  while(true){months.push(m);if(m===range.end.month)break;m=(m+1)%12;if(months.length>12)break}
  return months;
}
function toggleCatFilter(btn){
  btn.closest('.filter-bar').querySelectorAll('.pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');currentCatFilter=btn.dataset.cat;renderCalendar();
}
function renderCalendar(){
  if(!calendarData)return;
  const search=document.getElementById('cal-search').value.toLowerCase();
  let plants=calendarData.plants;
  if(currentCatFilter!=='all')plants=plants.filter(p=>p.category===currentCatFilter);
  if(search)plants=plants.filter(p=>p.name.toLowerCase().includes(search));

  let html='<table class="cal-table"><thead><tr><th></th>';
  MONTHS.forEach(m=>html+=`<th>${m}</th>`);
  html+='</tr></thead><tbody>';

  plants.forEach(p=>{
    const indoor=monthsInRange(parseDateRange(p.start_indoors_date));
    const outdoor=monthsInRange(parseDateRange(p.transplant_date||p.direct_sow_date));
    const sowRange=parseDateRange(p.direct_sow_date||p.transplant_date);
    let harvest=[];
    if(sowRange&&p.days_to_harvest){
      const hS=(sowRange.start.month+Math.floor(p.days_to_harvest/30))%12;
      const hE=(sowRange.end.month+Math.floor(p.days_to_harvest/30))%12;
      let m=hS;while(true){harvest.push(m);if(m===hE)break;m=(m+1)%12;if(harvest.length>4)break}
    }
    html+=`<tr><td class="pname" onclick="openModal(${p.id})">${p.name}</td>`;
    for(let i=0;i<12;i++){
      let cls='';
      if(indoor.includes(i))cls='cal-indoor';
      else if(outdoor.includes(i))cls='cal-outdoor';
      else if(harvest.includes(i))cls='cal-harvest';
      html+=`<td><div class="cal-bar ${cls}"></div></td>`;
    }
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('calendar-body').innerHTML=html;
}

// Modal
async function openModal(id){
  const p=allPlants.find(x=>x.id===id)||await fetch(`/api/plants/${id}`).then(r=>r.json());
  const companions=JSON.parse(p.companion_plants||'[]');
  const incompatible=JSON.parse(p.incompatible_plants||'[]');

  const indoor=monthsInRange(parseDateRange(p.start_indoors_date));
  const outdoor=monthsInRange(parseDateRange(p.transplant_date||p.direct_sow_date));
  const sowRange=parseDateRange(p.direct_sow_date||p.transplant_date);
  let harvestMonths=[];
  if(sowRange&&p.days_to_harvest){
    const hS=(sowRange.start.month+Math.floor(p.days_to_harvest/30))%12;
    const hE=(sowRange.end.month+Math.floor(p.days_to_harvest/30))%12;
    let m=hS;while(true){harvestMonths.push(m);if(m===hE)break;m=(m+1)%12;if(harvestMonths.length>4)break}
  }

  document.getElementById('modal-content').innerHTML=`
    <div class="modal-handle"></div>
    <button class="modal-close" onclick="closeModal()"><i data-lucide="x" style="width:16px;height:16px"></i></button>
    <h2>${p.name}</h2>
    <span class="badge badge-${p.category}">${p.category}</span>
    <span style="margin-left:6px;font-size:0.82rem;color:var(--text-dim)">${p.difficulty} &middot; ${p.frost_tolerance}</span>
    <p style="margin-top:12px;color:var(--text-secondary);font-size:0.92rem;line-height:1.6">${p.description||''}</p>
    <div class="detail-grid">
      <div class="detail-item"><i data-lucide="sun"></i> ${p.sun} sun</div>
      <div class="detail-item"><i data-lucide="droplets"></i> ${p.water} water</div>
      <div class="detail-item"><i data-lucide="timer"></i> ${p.days_to_harvest||'?'} days</div>
      <div class="detail-item"><i data-lucide="move-horizontal"></i> ${p.spacing_inches}" spacing</div>
      <div class="detail-item"><i data-lucide="arrow-down-to-line"></i> ${p.depth_inches}" depth</div>
      <div class="detail-item"><i data-lucide="thermometer"></i> ${p.frost_tolerance}</div>
    </div>
    <div class="detail-section">
      <h3>Planting Timeline</h3>
      <div class="timeline-months">${MONTHS.map((m,i)=>{
        let cls='';
        if(indoor.includes(i))cls='indoor';
        else if(outdoor.includes(i))cls='outdoor';
        else if(harvestMonths.includes(i))cls='harvest';
        return `<div class="tl-month ${cls}">${m}</div>`;
      }).join('')}</div>
      ${p.start_indoors_date?`<div class="date-row"><i data-lucide="home"></i> Indoors: ${p.start_indoors_date}</div>`:''}
      ${p.transplant_date?`<div class="date-row"><i data-lucide="move-right"></i> Transplant: ${p.transplant_date}</div>`:''}
      ${p.direct_sow_date?`<div class="date-row"><i data-lucide="shovel"></i> Direct sow: ${p.direct_sow_date}</div>`:''}
    </div>
    ${companions.length?`<div class="detail-section"><h3>Companion Plants</h3><div class="tag-list">${companions.map(c=>`<span class="tag tag-good">${c}</span>`).join('')}</div></div>`:''}
    ${incompatible.length?`<div class="detail-section"><h3>Keep Away From</h3><div class="tag-list">${incompatible.map(c=>`<span class="tag tag-bad">${c}</span>`).join('')}</div></div>`:''}
    ${p.tips?`<div class="detail-section"><h3>Growing Tips</h3><p style="color:var(--text-secondary);font-size:0.9rem;line-height:1.6">${p.tips}</p></div>`:''}
  `;
  document.getElementById('plant-modal').classList.add('open');
  lucide.createIcons();
}
function closeModal(){document.getElementById('plant-modal').classList.remove('open')}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});

// Garden Planner
function populatePlantSelect(){
  const sel=document.getElementById('plant-select');
  const cats={vegetable:[],herb:[],flower:[],fruit:[]};
  allPlants.forEach(p=>{if(cats[p.category])cats[p.category].push(p)});
  Object.entries(cats).forEach(([cat,plants])=>{
    if(!plants.length)return;
    const grp=document.createElement('optgroup');
    grp.label=cat.charAt(0).toUpperCase()+cat.slice(1)+'s';
    plants.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=`${p.name} (${p.spacing_inches}")`;grp.appendChild(o)});
    sel.appendChild(grp);
  });
  sel.addEventListener('change',()=>{
    selectedPlantId=sel.value?parseInt(sel.value):null;
    const ind=document.getElementById('selected-indicator');
    if(selectedPlantId){
      const plant=allPlants.find(p=>p.id===selectedPlantId);
      ind.style.display='flex';
      ind.innerHTML=`<i data-lucide="target"></i> Placing: <strong>${plant.name}</strong> (${plant.spacing_inches}" spacing)`;
      lucide.createIcons();
    }else{ind.style.display='none'}
  });
}

function createGrid(){
  gridW=parseInt(document.getElementById('bed-width').value);
  gridH=parseInt(document.getElementById('bed-height').value);
  gridData={};renderGrid();
}
function renderGrid(){
  const wrapper=document.getElementById('grid-wrapper');
  const cols=gridW*2,rows=gridH*2;
  let html=`<div class="garden-grid" style="grid-template-columns:repeat(${cols},44px)">`;
  for(let y=0;y<rows;y++){for(let x=0;x<cols;x++){
    const key=`${x},${y}`;const cell=gridData[key];
    let cls='',label='';
    if(cell){
      cls='filled';label=cell.name.substring(0,5);
      const neighbors=getNeighborPlants(x,y);
      const comp=JSON.parse(cell.companion_plants||'[]').map(s=>s.toLowerCase());
      const incompat=JSON.parse(cell.incompatible_plants||'[]').map(s=>s.toLowerCase());
      let hasGood=false,hasBad=false;
      neighbors.forEach(n=>{if(comp.includes(n.toLowerCase()))hasGood=true;if(incompat.includes(n.toLowerCase()))hasBad=true});
      if(hasBad)cls+=' conflict';else if(hasGood)cls+=' good-companion';
    }
    html+=`<div class="garden-cell ${cls}" onclick="placeCell(${x},${y})">${label}</div>`;
  }}
  html+='</div>';wrapper.innerHTML=html;
}
function getNeighborPlants(x,y){
  const names=[];
  [[-1,0],[1,0],[0,-1],[0,1]].forEach(([dx,dy])=>{const c=gridData[`${x+dx},${y+dy}`];if(c)names.push(c.name)});
  return names;
}
function placeCell(x,y){
  if(!selectedPlantId)return;const key=`${x},${y}`;
  if(gridData[key]&&gridData[key].id===selectedPlantId)delete gridData[key];
  else gridData[key]=allPlants.find(p=>p.id===selectedPlantId);
  renderGrid();
}
function clearGrid(){gridData={};renderGrid()}

function saveLayout(){
  const name=document.getElementById('layout-name').value||'Untitled';
  const layouts=JSON.parse(localStorage.getItem('pm-layouts')||'[]');
  layouts.push({name,width:gridW,height:gridH,grid:gridData,date:new Date().toISOString()});
  localStorage.setItem('pm-layouts',JSON.stringify(layouts));loadSavedLayouts();
  document.getElementById('layout-name').value='';
}
function loadSavedLayouts(){
  const layouts=JSON.parse(localStorage.getItem('pm-layouts')||'[]');
  const el=document.getElementById('saved-layouts');
  if(!layouts.length){el.innerHTML='<p style="color:var(--text-dim);font-size:0.85rem;padding:8px 0">No saved layouts yet</p>';return}
  el.innerHTML=layouts.map((l,i)=>`<div class="saved-item">
    <div class="info"><h4>${l.name}</h4><p>${l.width}' x ${l.height}' &middot; ${new Date(l.date).toLocaleDateString()}</p></div>
    <div class="actions">
      <button onclick="loadLayout(${i})"><i data-lucide="upload" style="width:18px;height:18px"></i></button>
      <button onclick="deleteLayout(${i})"><i data-lucide="trash-2" style="width:18px;height:18px"></i></button>
    </div>
  </div>`).join('');
  lucide.createIcons();
}
function loadLayout(i){
  const l=JSON.parse(localStorage.getItem('pm-layouts')||'[]')[i];
  gridW=l.width;gridH=l.height;
  document.getElementById('bed-width').value=gridW;
  document.getElementById('bed-height').value=gridH;
  gridData={};
  Object.entries(l.grid).forEach(([key,val])=>{const plant=allPlants.find(p=>p.id===val.id);if(plant)gridData[key]=plant});
  renderGrid();
}
function deleteLayout(i){
  const layouts=JSON.parse(localStorage.getItem('pm-layouts')||'[]');
  layouts.splice(i,1);localStorage.setItem('pm-layouts',JSON.stringify(layouts));loadSavedLayouts();
}

init();
</script>
</body>
</html>
